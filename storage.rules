rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Rules for traditional test file uploads by employers
    // Example path: tradTest/employer-uid-123/test-file.pdf
    match /tradTest/{employerId}/{allPaths=**} {
      // Allow an employer to write (upload, update, delete) to their own folder.
      allow write: if request.auth != null && request.auth.uid == employerId;
      
      // Allow authenticated users to read test files.
      // This is a basic rule; you might want to restrict this further
      // to only candidates who have been invited to the test.
      allow read: if request.auth != null;
    }

    // Rules for test submissions by candidates
    // Example path: testSubmissions/post-id-456/candidate-uid-789/submission.pdf
    match /testSubmissions/{postId}/{candidateId}/{allPaths=**} {
      // Allow a candidate to write (upload) their own submission.
      allow write: if request.auth != null && request.auth.uid == candidateId;

      // Allow the candidate who submitted it OR the employer who owns the post to read.
      // This assumes you have collections 'jobs' and 'internships' with an 'employerId' field.
      allow read: if request.auth != null && (
        request.auth.uid == candidateId ||
        (exists(/databases/(default)/documents/jobs/$(postId)) && 
         get(/databases/(default)/documents/jobs/$(postId)).data.employerId == request.auth.uid) ||
        (exists(/databases/(default)/documents/internships/$(postId)) &&
         get(/databases/(default)/documents/internships/$(postId)).data.employerId == request.auth.uid)
      );
    }
  }
}
