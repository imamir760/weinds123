rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Matches any file in the `traditional-tests` folder
    match /traditional-tests/{employerId}/{postId}/{fileName} {
      // Only the authenticated user whose UID matches the {employerId} in the path
      // can upload files to their own folder.
      allow create: if request.auth != null && request.auth.uid == employerId;

      // Anyone can read the test files (e.g., candidates with the URL)
      allow read: if true;
    }

     // Matches any file in the `test-submissions` folder
    match /test-submissions/{postId}/{candidateId}/{fileName} {
        // A candidate can only upload to their own submission path
        allow create: if request.auth != null && request.auth.uid == candidateId;
        // The candidate and the employer who owns the post can read the submission
        allow read: if request.auth != null && (request.auth.uid == candidateId || exists(/databases/(default)/documents/jobs/$(postId)) && get(/databases/(default)/documents/jobs/$(postId)).data.employerId == request.auth.uid || exists(/databases/(default)/documents/internships/$(postId)) && get(/databases/(default)/documents/internships/$(postId)).data.employerId == request.auth.uid);
    }
  }
}
